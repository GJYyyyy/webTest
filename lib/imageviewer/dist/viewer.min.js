!function(factory){"function"==typeof define&&define.amd?define("viewer",["jquery"],factory):factory("object"==typeof exports?require("jquery"):jQuery)}(function($){"use strict";function isString(s){return"string"==typeof s}function isNumber(n){return"number"==typeof n&&!isNaN(n)}function isUndefined(u){return"undefined"==typeof u}function toArray(obj,offset){var args=[];return isNumber(offset)&&args.push(offset),args.slice.apply(obj,args)}function proxy(fn,context){var args=toArray(arguments,2);return function(){return fn.apply(context,args.concat(toArray(arguments)))}}function fnRotateScale(angle,scale,obj){var angle=parseFloat(angle)||0,scale=parseFloat(scale)||1,rad=angle*(Math.PI/180),m11=Math.cos(rad)*scale,m12=-1*Math.sin(rad)*scale,m21=Math.sin(rad)*scale,m22=m11,width=parseFloat(obj.width),height=parseFloat(obj.height),dx=-width/2*Math.cos(rad)+height/2*Math.sin(rad)+width/2,dy=-width/2*Math.sin(rad)-height/2*Math.cos(rad)+height/2,filter="progid:DXImageTransform.Microsoft.Matrix(Dx="+dx+",Dy="+dy+",M11="+m11+",M12="+m12+",M21="+m21+",M22="+m22+",SizingMethod='auto expand')";return filter}function getFilter(options){if(!document.querySelector||window.addEventListener)return"";var angle=options.rotate,scaleX=options.scaleX;return isNumber(angle)?fnRotateScale(angle,scaleX,options):void 0}function getTransform(options){var transforms=[],rotate=options.rotate,scaleX=options.scaleX,scaleY=options.scaleY;return isNumber(rotate)&&transforms.push("rotate("+rotate+"deg)"),isNumber(scaleX)&&isNumber(scaleY)&&transforms.push("scale("+scaleX+","+scaleY+")"),transforms.length?transforms.join(" "):"none"}function forceReflow(element){return element.offsetWidth}function getImageName(url){return isString(url)?url.replace(/^.*\//,"").replace(/[\?&#].*$/,""):""}function getImageSize(image,callback){var newImage;return image.naturalWidth?callback(image.naturalWidth,image.naturalHeight):(newImage=document.createElement("img"),newImage.onload=function(){callback(this.width,this.height)},void(newImage.src=image.src))}function getTouchesCenter(touches){var length=touches.length,pageX=0,pageY=0;return length&&($.each(touches,function(i,touch){pageX+=touch.pageX,pageY+=touch.pageY}),pageX/=length,pageY/=length),{pageX:pageX,pageY:pageY}}function getResponsiveClass(option){switch(option){case 2:return CLASS_HIDE_XS_DOWN;case 3:return CLASS_HIDE_SM_DOWN;case 4:return CLASS_HIDE_MD_DOWN}}function Viewer(element,options){this.$element=$(element),this.options=$.extend({},Viewer.DEFAULTS,$.isPlainObject(options)&&options),this.isImg=!1,this.isBuilt=!1,this.isShown=!1,this.isViewed=!1,this.isFulled=!1,this.isPlayed=!1,this.wheeling=!1,this.playing=!1,this.fading=!1,this.tooltiping=!1,this.transitioning=!1,this.action=!1,this.target=!1,this.timeout=!1,this.index=0,this.length=0,this.init()}var flag=0,$window=$(window),$document=$(document),NAMESPACE="viewer",ELEMENT_VIEWER=document.createElement(NAMESPACE),CLASS_FIXED="viewer-fixed",CLASS_OPEN="viewer-open",CLASS_SHOW="viewer-show",CLASS_HIDE="viewer-hide",CLASS_HIDE_XS_DOWN="viewer-hide-xs-down",CLASS_HIDE_SM_DOWN="viewer-hide-sm-down",CLASS_HIDE_MD_DOWN="viewer-hide-md-down",CLASS_FADE="viewer-fade",CLASS_IN="viewer-in",CLASS_MOVE="viewer-move",CLASS_ACTIVE="viewer-active",CLASS_INVISIBLE="viewer-invisible",CLASS_TRANSITION="viewer-transition",CLASS_FULLSCREEN="viewer-fullscreen",CLASS_FULLSCREEN_EXIT="viewer-fullscreen-exit",CLASS_CLOSE="viewer-close",SELECTOR_IMG="img",EVENT_MOUSEDOWN="mousedown touchstart pointerdown MSPointerDown",EVENT_MOUSEMOVE="mousemove touchmove pointermove MSPointerMove",EVENT_MOUSEUP="mouseup touchend touchcancel pointerup pointercancel MSPointerUp MSPointerCancel",EVENT_WHEEL="wheel mousewheel DOMMouseScroll",EVENT_TRANSITIONEND="transitionend",EVENT_LOAD="load."+NAMESPACE,EVENT_KEYDOWN="keydown."+NAMESPACE,EVENT_CLICK="click."+NAMESPACE,EVENT_RESIZE="resize."+NAMESPACE,EVENT_BUILD="build."+NAMESPACE,EVENT_BUILT="built."+NAMESPACE,EVENT_SHOW="show."+NAMESPACE,EVENT_SHOWN="shown."+NAMESPACE,EVENT_HIDE="hide."+NAMESPACE,EVENT_HIDDEN="hidden."+NAMESPACE,EVENT_VIEW="view."+NAMESPACE,EVENT_VIEWED="viewed."+NAMESPACE,SUPPORT_TRANSITION="undefined"!=typeof ELEMENT_VIEWER.style.transition,round=Math.round,sqrt=Math.sqrt,abs=Math.abs,min=Math.min,max=Math.max,num=Number;Viewer.prototype={constructor:Viewer,init:function(){var options=this.options,$this=this.$element,isImg=$this.is(SELECTOR_IMG),$images=isImg?$this:$this.find(SELECTOR_IMG),length=$images.length,ready=$.proxy(this.ready,this);length&&($.isFunction(options.build)&&$this.one(EVENT_BUILD,options.build),this.trigger(EVENT_BUILD).isDefaultPrevented()||(SUPPORT_TRANSITION||(options.transition=!1),this.isImg=isImg,this.length=length,this.count=0,this.$images=$images,this.$body=$("body"),options.inline?($this.one(EVENT_BUILT,$.proxy(function(){this.view()},this)),$images.each(function(){this.complete?ready():$(this).one(EVENT_LOAD,ready)})):$this.on(EVENT_CLICK,$.proxy(this.start,this))))},ready:function(){this.count++,this.count===this.length&&this.build()},build:function(){var $parent,$viewer,$title,$toolbar,$navbar,$button,options=this.options,$this=this.$element;this.isBuilt||(this.$parent=$parent=$this.parent(),this.$viewer=$viewer=$(Viewer.TEMPLATE),this.$canvas=$viewer.find(".viewer-canvas"),this.$footer=$viewer.find(".viewer-footer"),this.$title=$title=$viewer.find(".viewer-title"),this.$toolbar=$toolbar=$viewer.find(".viewer-toolbar"),this.$navbar=$navbar=$viewer.find(".viewer-navbar"),this.$button=$button=$viewer.find(".viewer-button"),this.$tooltip=$viewer.find(".viewer-tooltip"),this.$player=$viewer.find(".viewer-player"),this.$list=$viewer.find(".viewer-list"),$title.addClass(options.title?getResponsiveClass(options.title):CLASS_HIDE),$toolbar.addClass(options.toolbar?getResponsiveClass(options.toolbar):CLASS_HIDE),$toolbar.find("li[class*=zoom]").toggleClass(CLASS_INVISIBLE,!options.zoomable),$toolbar.find("li[class*=flip]").toggleClass(CLASS_INVISIBLE,!options.scalable),options.rotatable||$toolbar.find("li[class*=rotate]").addClass(CLASS_INVISIBLE).appendTo($toolbar),$navbar.addClass(options.navbar?getResponsiveClass(options.navbar):CLASS_HIDE),$button.toggleClass(CLASS_HIDE,!options.button),options.inline?($button.addClass(CLASS_FULLSCREEN),$viewer.css("z-index",options.zIndexInline),"static"===$parent.css("position")&&$parent.css("position","relative")):($button.addClass(CLASS_CLOSE),$viewer.css("z-index",options.zIndex).addClass([CLASS_FIXED,CLASS_FADE,CLASS_HIDE].join(" "))),$this.after($viewer),options.inline&&(this.render(),this.bind(),this.isShown=!0),this.isBuilt=!0,$.isFunction(options.built)&&$this.one(EVENT_BUILT,options.built),this.trigger(EVENT_BUILT))},unbuild:function(){this.isBuilt&&(this.isBuilt=!1,this.$viewer.remove())},bind:function(){var options=this.options,$this=this.$element;$.isFunction(options.view)&&$this.on(EVENT_VIEW,options.view),$.isFunction(options.viewed)&&$this.on(EVENT_VIEWED,options.viewed),this.$viewer.on(EVENT_CLICK,$.proxy(this.click,this)).on(EVENT_WHEEL,$.proxy(this.wheel,this)),this.$canvas.on(EVENT_MOUSEDOWN,$.proxy(this.mousedown,this)),$document.on(EVENT_MOUSEMOVE,this._mousemove=proxy(this.mousemove,this)).on(EVENT_MOUSEUP,this._mouseup=proxy(this.mouseup,this)).on(EVENT_KEYDOWN,this._keydown=proxy(this.keydown,this)),$window.on(EVENT_RESIZE,this._resize=proxy(this.resize,this))},unbind:function(){var options=this.options,$this=this.$element;$.isFunction(options.view)&&$this.off(EVENT_VIEW,options.view),$.isFunction(options.viewed)&&$this.off(EVENT_VIEWED,options.viewed),this.$viewer.off(EVENT_CLICK,this.click).off(EVENT_WHEEL,this.wheel),this.$canvas.off(EVENT_MOUSEDOWN,this.mousedown),$document.off(EVENT_MOUSEMOVE,this._mousemove).off(EVENT_MOUSEUP,this._mouseup).off(EVENT_KEYDOWN,this._keydown),$window.off(EVENT_RESIZE,this._resize)},render:function(){this.initContainer(),this.initViewer(),this.initList(),this.renderViewer()},initContainer:function(){this.container={width:$window.innerWidth(),height:$window.innerHeight()}},initViewer:function(){var viewer,options=this.options,$parent=this.$parent;options.inline&&(this.parent=viewer={width:max($parent.width(),options.minWidth),height:max($parent.height(),options.minHeight)}),!this.isFulled&&viewer||(viewer=this.container),this.viewer=$.extend({},viewer)},renderViewer:function(){this.options.inline&&!this.isFulled&&this.$viewer.css(this.viewer)},initList:function(){var options=this.options,$this=this.$element,$list=this.$list,list=[];this.$images.each(function(i){var src=this.src,alt=this.alt||getImageName(src),url=options.url;src&&(isString(url)?url=this.getAttribute(url):$.isFunction(url)&&(url=url.call(this,this)),list.push('<li><img src="'+src+'" data-action="view" data-index="'+i+'" data-original-url="'+(url||src)+'" alt="'+alt+'"></li>'))}),$list.html(list.join("")).find(SELECTOR_IMG).one(EVENT_LOAD,{filled:!0},$.proxy(this.loadImage,this)),this.$items=$list.children(),options.transition&&$this.one(EVENT_VIEWED,function(){$list.addClass(CLASS_TRANSITION)})},renderList:function(index){var i=index||this.index,width=this.$items.eq(i).width(),outerWidth=width+1;this.$list.css({width:outerWidth*this.length,marginLeft:(this.viewer.width-width)/2-outerWidth*i})},resetList:function(){this.$list.empty().removeClass(CLASS_TRANSITION).css("margin-left",0)},initImage:function(callback){var options=this.options,$image=this.$image,viewer=this.viewer,footerHeight=this.$footer.height(),viewerWidth=viewer.width,viewerHeight=max(viewer.height-footerHeight,footerHeight),oldImage=this.image||{};getImageSize($image[0],$.proxy(function(naturalWidth,naturalHeight){var initialImage,image,aspectRatio=naturalWidth/naturalHeight,width=viewerWidth,height=viewerHeight;viewerHeight*aspectRatio>viewerWidth?height=viewerWidth/aspectRatio:width=viewerHeight*aspectRatio,width=min(.9*width,naturalWidth),height=min(.9*height,naturalHeight),image={naturalWidth:naturalWidth,naturalHeight:naturalHeight,aspectRatio:aspectRatio,ratio:width/naturalWidth,width:width,height:height,left:(viewerWidth-width)/2,top:(viewerHeight-height)/2},initialImage=$.extend({},image),options.rotatable&&(image.rotate=oldImage.rotate||0,initialImage.rotate=0),options.scalable&&(image.scaleX=oldImage.scaleX||1,image.scaleY=oldImage.scaleY||1,initialImage.scaleX=1,initialImage.scaleY=1),this.image=image,this.initialImage=initialImage,$.isFunction(callback)&&callback()},this))},renderImage:function(callback){var image=this.image,$image=this.$image;$image.css({width:image.width,height:image.height,marginLeft:image.left,marginTop:image.top,transform:getTransform(image),filter:getFilter(image)}),$.isFunction(callback)&&(this.transitioning?$image.one(EVENT_TRANSITIONEND,callback):callback())},resetImage:function(){this.$image&&(this.$image.remove(),this.$image=null)},start:function(e){var target=e.target;$(target).is("img")&&(this.target=target,this.show())},click:function(e){var $target=$(e.target),action=$target.data("action"),image=this.image;switch(action){case"mix":this.isPlayed?this.stop():this.options.inline?this.isFulled?this.exit():this.full():this.hide();break;case"view":this.view($target.data("index"));break;case"zoom-in":this.zoom(.1,!0);break;case"zoom-out":this.zoom(-.1,!0);break;case"one-to-one":this.toggle();break;case"reset":this.reset();break;case"prev":this.prev();break;case"play":this.play();break;case"next":this.next();break;case"rotate-left":this.rotate(-90),flag=++flag%2,document.querySelector&&!window.addEventListener&&1==flag&&this.$image.css({position:"relative",left:(this.$image.height()-this.$image.width())/2+"px",top:(this.$image.width()-this.$image.height())/2+"px"}),document.querySelector&&!window.addEventListener&&0==flag&&this.$image.css({position:"relative",left:0,top:0});break;case"rotate-right":this.rotate(90),flag=++flag%2,document.querySelector&&!window.addEventListener&&1==flag&&this.$image.css({position:"relative",left:(this.$image.height()-this.$image.width())/2+"px",top:(this.$image.width()-this.$image.height())/2+"px"}),document.querySelector&&!window.addEventListener&&0==flag&&this.$image.css({position:"relative",left:0,top:0});break;case"flip-horizontal":this.scaleX(-image.scaleX||-1);break;case"flip-vertical":this.scaleY(-image.scaleY||-1);break;default:this.isPlayed&&this.stop()}},load:function(){var options=this.options,viewer=this.viewer,$image=this.$image;this.timeout&&(clearTimeout(this.timeout),this.timeout=!1),$image.removeClass(CLASS_INVISIBLE).css("cssText","width:0;height:0;margin-left:"+viewer.width/2+"px;margin-top:"+viewer.height/2+"px;max-width:none!important;visibility:visible;"),this.initImage($.proxy(function(){$image.toggleClass(CLASS_TRANSITION,options.transition).toggleClass(CLASS_MOVE,options.movable),this.renderImage($.proxy(function(){this.isViewed=!0,this.trigger(EVENT_VIEWED)},this))},this))},loadImage:function(e){var image=e.target,$image=$(image),$parent=$image.parent(),parentWidth=$parent.width(),parentHeight=$parent.height(),filled=e.data&&e.data.filled;getImageSize(image,function(naturalWidth,naturalHeight){var aspectRatio=naturalWidth/naturalHeight,width=parentWidth,height=parentHeight;parentHeight*aspectRatio>parentWidth?filled?width=parentHeight*aspectRatio:height=parentWidth/aspectRatio:filled?height=parentWidth/aspectRatio:width=parentHeight*aspectRatio,$image.css({width:width,height:height,marginLeft:(parentWidth-width)/2,marginTop:(parentHeight-height)/2})})},resize:function(){this.initContainer(),this.initViewer(),this.renderViewer(),this.renderList(),this.isViewed&&this.initImage($.proxy(function(){this.renderImage()},this)),this.isPlayed&&this.$player.find(SELECTOR_IMG).one(EVENT_LOAD,$.proxy(this.loadImage,this)).trigger(EVENT_LOAD)},wheel:function(event){var e=event.originalEvent||event,ratio=num(this.options.zoomRatio)||.1,delta=1;this.isViewed&&(event.preventDefault(),this.wheeling||(this.wheeling=!0,setTimeout($.proxy(function(){this.wheeling=!1},this),50),e.deltaY?delta=e.deltaY>0?1:-1:e.wheelDelta?delta=-e.wheelDelta/120:e.detail&&(delta=e.detail>0?1:-1),this.zoom(-delta*ratio,!0,event)))},keydown:function(e){var options=this.options,which=e.which;if(this.isFulled&&options.keyboard)switch(which){case 27:this.isPlayed?this.stop():options.inline?this.isFulled&&this.exit():this.hide();break;case 32:this.isPlayed&&this.stop();break;case 37:this.prev();break;case 38:e.preventDefault(),this.zoom(options.zoomRatio,!0);break;case 39:this.next();break;case 40:e.preventDefault(),this.zoom(-options.zoomRatio,!0);break;case 48:case 49:(e.ctrlKey||e.shiftKey)&&(e.preventDefault(),this.toggle())}},mousedown:function(event){var touchesLength,options=this.options,originalEvent=event.originalEvent,touches=originalEvent&&originalEvent.touches,e=event,action=!!options.movable&&"move";if(this.isViewed){if(touches){if(touchesLength=touches.length,touchesLength>1){if(!options.zoomable||2!==touchesLength)return;e=touches[1],this.startX2=e.pageX,this.startY2=e.pageY,action="zoom"}else this.isSwitchable()&&(action="switch");e=touches[0]}action&&(event.preventDefault(),this.action=action,this.startX=e.pageX||originalEvent&&originalEvent.pageX,this.startY=e.pageY||originalEvent&&originalEvent.pageY)}},mousemove:function(event){var touchesLength,options=this.options,action=this.action,$image=this.$image,originalEvent=event.originalEvent,touches=originalEvent&&originalEvent.touches,e=event;if(this.isViewed){if(touches){if(touchesLength=touches.length,touchesLength>1){if(!options.zoomable||2!==touchesLength)return;e=touches[1],this.endX2=e.pageX,this.endY2=e.pageY}e=touches[0]}action&&(event.preventDefault(),"move"===action&&options.transition&&$image.hasClass(CLASS_TRANSITION)&&$image.removeClass(CLASS_TRANSITION),this.endX=e.pageX||originalEvent&&originalEvent.pageX,this.endY=e.pageY||originalEvent&&originalEvent.pageY,this.change(event))}},mouseup:function(event){var action=this.action;action&&(event.preventDefault(),"move"===action&&this.options.transition&&this.$image.addClass(CLASS_TRANSITION),this.action=!1)},show:function(){var $viewer,options=this.options;options.inline||this.transitioning||(this.isBuilt||this.build(),$.isFunction(options.show)&&this.$element.one(EVENT_SHOW,options.show),this.trigger(EVENT_SHOW).isDefaultPrevented()||(this.$body.addClass(CLASS_OPEN),$viewer=this.$viewer.removeClass(CLASS_HIDE),this.$element.one(EVENT_SHOWN,$.proxy(function(){this.view(this.target?this.$images.index(this.target):this.index),this.target=!1},this)),options.transition?(this.transitioning=!0,$viewer.addClass(CLASS_TRANSITION),forceReflow($viewer[0]),$viewer.one(EVENT_TRANSITIONEND,$.proxy(this.shown,this)).addClass(CLASS_IN)):($viewer.addClass(CLASS_IN),this.shown())))},hide:function(){var options=this.options,$viewer=this.$viewer;options.inline||this.transitioning||!this.isShown||($.isFunction(options.hide)&&this.$element.one(EVENT_HIDE,options.hide),this.trigger(EVENT_HIDE).isDefaultPrevented()||(this.isViewed&&options.transition?(this.transitioning=!0,this.$image.one(EVENT_TRANSITIONEND,$.proxy(function(){$viewer.one(EVENT_TRANSITIONEND,$.proxy(this.hidden,this)).removeClass(CLASS_IN)},this)),this.zoomTo(0,!1,!1,!0)):($viewer.removeClass(CLASS_IN),this.hidden())))},view:function(index){var $image,$item,$img,url,alt,$title=this.$title;index=Number(index)||0,!this.isShown||this.isPlayed||index<0||index>=this.length||this.isViewed&&index===this.index||this.trigger(EVENT_VIEW).isDefaultPrevented()||($item=this.$items.eq(index),$img=$item.find(SELECTOR_IMG),url=$img.data("originalUrl"),alt=$img.attr("alt"),this.$image=$image=$('<img src="'+url+'" alt="'+alt+'">'),this.isViewed&&this.$items.eq(this.index).removeClass(CLASS_ACTIVE),$item.addClass(CLASS_ACTIVE),this.isViewed=!1,this.index=index,this.image=null,this.$canvas.html($image.addClass(CLASS_INVISIBLE)),this.renderList(),$title.empty(),this.$element.one(EVENT_VIEWED,$.proxy(function(){var image=this.image,width=image.naturalWidth,height=image.naturalHeight;$title.html(alt+" ("+width+" &times; "+height+")")},this)),$image[0].complete?this.load():($image.one(EVENT_LOAD,$.proxy(this.load,this)),this.timeout&&clearTimeout(this.timeout),this.timeout=setTimeout($.proxy(function(){$image.removeClass(CLASS_INVISIBLE),this.timeout=!1},this),1e3)))},prev:function(){this.view(max(this.index-1,0))},next:function(){this.view(min(this.index+1,this.length-1))},move:function(offsetX,offsetY){var image=this.image;this.moveTo(isUndefined(offsetX)?offsetX:image.left+num(offsetX),isUndefined(offsetY)?offsetY:image.top+num(offsetY))},moveTo:function(x,y){var image=this.image,changed=!1;isUndefined(y)&&(y=x),x=num(x),y=num(y),this.isViewed&&!this.isPlayed&&this.options.movable&&(isNumber(x)&&(image.left=x,changed=!0),isNumber(y)&&(image.top=y,changed=!0),changed&&this.renderImage())},zoom:function(ratio,hasTooltip,_event){var image=this.image;ratio=num(ratio),ratio=ratio<0?1/(1-ratio):1+ratio,this.zoomTo(image.width*ratio/image.naturalWidth,hasTooltip,_event)},zoomTo:function(ratio,hasTooltip,_event,_zoomable){var originalEvent,newWidth,newHeight,offset,center,options=this.options,minZoomRatio=.01,maxZoomRatio=100,image=this.image,width=image.width,height=image.height;ratio=max(0,ratio),isNumber(ratio)&&this.isViewed&&!this.isPlayed&&(_zoomable||options.zoomable)&&(_zoomable||(minZoomRatio=max(minZoomRatio,options.minZoomRatio),maxZoomRatio=min(maxZoomRatio,options.maxZoomRatio),ratio=min(max(ratio,minZoomRatio),maxZoomRatio)),ratio>.95&&ratio<1.05&&(ratio=1),newWidth=image.naturalWidth*ratio,newHeight=image.naturalHeight*ratio,_event&&(originalEvent=_event.originalEvent)?(offset=this.$viewer.offset(),center=originalEvent.touches?getTouchesCenter(originalEvent.touches):{pageX:_event.pageX||originalEvent.pageX||0,pageY:_event.pageY||originalEvent.pageY||0},image.left-=(newWidth-width)*((center.pageX-offset.left-image.left)/width),image.top-=(newHeight-height)*((center.pageY-offset.top-image.top)/height)):(image.left-=(newWidth-width)/2,image.top-=(newHeight-height)/2),image.width=newWidth,image.height=newHeight,image.ratio=ratio,this.renderImage(),hasTooltip&&this.tooltip())},rotate:function(degree){this.rotateTo((this.image.rotate||0)+num(degree))},rotateTo:function(degree){var image=this.image;degree=num(degree),isNumber(degree)&&this.isViewed&&!this.isPlayed&&this.options.rotatable&&(image.rotate=degree,this.renderImage())},scale:function(scaleX,scaleY){var image=this.image,changed=!1;isUndefined(scaleY)&&(scaleY=scaleX),scaleX=num(scaleX),scaleY=num(scaleY),this.isViewed&&!this.isPlayed&&this.options.scalable&&(isNumber(scaleX)&&(image.scaleX=scaleX,changed=!0),isNumber(scaleY)&&(image.scaleY=scaleY,changed=!0),changed&&this.renderImage())},scaleX:function(scaleX){this.scale(scaleX,this.image.scaleY)},scaleY:function(scaleY){this.scale(this.image.scaleX,scaleY)},play:function(){var playing,options=this.options,$player=this.$player,load=$.proxy(this.loadImage,this),list=[],total=0,index=0;this.isShown&&!this.isPlayed&&(options.fullscreen&&this.requestFullscreen(),this.isPlayed=!0,$player.addClass(CLASS_SHOW),this.$items.each(function(i){var $this=$(this),$img=$this.find(SELECTOR_IMG),$image=$('<img src="'+$img.data("originalUrl")+'" alt="'+$img.attr("alt")+'">');total++,$image.addClass(CLASS_FADE).toggleClass(CLASS_TRANSITION,options.transition),$this.hasClass(CLASS_ACTIVE)&&($image.addClass(CLASS_IN),index=i),list.push($image),$image.one(EVENT_LOAD,{filled:!1},load),$player.append($image)}),isNumber(options.interval)&&options.interval>0&&(playing=$.proxy(function(){this.playing=setTimeout(function(){list[index].removeClass(CLASS_IN),index++,index=index<total?index:0,list[index].addClass(CLASS_IN),playing()},options.interval)},this),total>1&&playing()))},stop:function(){this.isPlayed&&(this.options.fullscreen&&this.exitFullscreen(),this.isPlayed=!1,clearTimeout(this.playing),this.$player.removeClass(CLASS_SHOW).empty())},full:function(){var options=this.options,$image=this.$image,$list=this.$list;this.isShown&&!this.isPlayed&&!this.isFulled&&options.inline&&(this.isFulled=!0,this.$body.addClass(CLASS_OPEN),this.$button.addClass(CLASS_FULLSCREEN_EXIT),options.transition&&($image.removeClass(CLASS_TRANSITION),$list.removeClass(CLASS_TRANSITION)),this.$viewer.addClass(CLASS_FIXED).removeAttr("style").css("z-index",options.zIndex),this.initContainer(),this.viewer=$.extend({},this.container),this.renderList(),this.initImage($.proxy(function(){this.renderImage(function(){options.transition&&setTimeout(function(){$image.addClass(CLASS_TRANSITION),$list.addClass(CLASS_TRANSITION)},0)})},this)))},exit:function(){var options=this.options,$image=this.$image,$list=this.$list;this.isFulled&&(this.isFulled=!1,this.$body.removeClass(CLASS_OPEN),this.$button.removeClass(CLASS_FULLSCREEN_EXIT),options.transition&&($image.removeClass(CLASS_TRANSITION),$list.removeClass(CLASS_TRANSITION)),this.$viewer.removeClass(CLASS_FIXED).css("z-index",options.zIndexInline),this.viewer=$.extend({},this.parent),this.renderViewer(),this.renderList(),this.initImage($.proxy(function(){this.renderImage(function(){options.transition&&setTimeout(function(){$image.addClass(CLASS_TRANSITION),$list.addClass(CLASS_TRANSITION)},0)})},this)))},tooltip:function(){var options=this.options,$tooltip=this.$tooltip,image=this.image,classes=[CLASS_SHOW,CLASS_FADE,CLASS_TRANSITION].join(" ");this.isViewed&&!this.isPlayed&&options.tooltip&&($tooltip.text(round(100*image.ratio)+"%"),this.tooltiping?clearTimeout(this.tooltiping):options.transition?(this.fading&&$tooltip.trigger(EVENT_TRANSITIONEND),$tooltip.addClass(classes),forceReflow($tooltip[0]),$tooltip.addClass(CLASS_IN)):$tooltip.addClass(CLASS_SHOW),this.tooltiping=setTimeout($.proxy(function(){options.transition?($tooltip.one(EVENT_TRANSITIONEND,$.proxy(function(){$tooltip.removeClass(classes),this.fading=!1},this)).removeClass(CLASS_IN),this.fading=!0):$tooltip.removeClass(CLASS_SHOW),this.tooltiping=!1},this),1e3))},toggle:function(){1===this.image.ratio?this.zoomTo(this.initialImage.ratio,!0):this.zoomTo(1,!0)},reset:function(){this.isViewed&&!this.isPlayed&&(this.image=$.extend({},this.initialImage),this.renderImage())},update:function(){var index,$this=this.$element,$images=this.$images,indexes=[];if(this.isImg){if(!$this.parent().length)return this.destroy()}else this.$images=$images=$this.find(SELECTOR_IMG),this.length=$images.length;this.isBuilt&&($.each(this.$items,function(i){var img=$(this).find("img")[0],image=$images[i];image?image.src!==img.src&&indexes.push(i):indexes.push(i)}),this.$list.width("auto"),this.initList(),this.isShown&&(this.length?this.isViewed&&(index=$.inArray(this.index,indexes),index>=0?(this.isViewed=!1,this.view(max(this.index-(index+1),0))):this.$items.eq(this.index).addClass(CLASS_ACTIVE)):(this.$image=null,this.isViewed=!1,this.index=0,this.image=null,this.$canvas.empty(),this.$title.empty())))},destroy:function(){var $this=this.$element;this.options.inline?this.unbind():(this.isShown&&this.unbind(),$this.off(EVENT_CLICK,this.start)),this.unbuild(),$this.removeData(NAMESPACE)},trigger:function(type,data){var e=$.Event(type,data);return this.$element.trigger(e),e},shown:function(){var options=this.options;this.transitioning=!1,this.isFulled=!0,this.isShown=!0,this.isVisible=!0,this.render(),this.bind(),$.isFunction(options.shown)&&this.$element.one(EVENT_SHOWN,options.shown),this.trigger(EVENT_SHOWN)},hidden:function(){var options=this.options;this.transitioning=!1,this.isViewed=!1,this.isFulled=!1,this.isShown=!1,this.isVisible=!1,this.unbind(),this.$body.removeClass(CLASS_OPEN),this.$viewer.addClass(CLASS_HIDE),this.resetList(),this.resetImage(),$.isFunction(options.hidden)&&this.$element.one(EVENT_HIDDEN,options.hidden),this.trigger(EVENT_HIDDEN)},requestFullscreen:function(){var documentElement=document.documentElement;!this.isFulled||document.fullscreenElement||document.mozFullScreenElement||document.webkitFullscreenElement||document.msFullscreenElement||(documentElement.requestFullscreen?documentElement.requestFullscreen():documentElement.msRequestFullscreen?documentElement.msRequestFullscreen():documentElement.mozRequestFullScreen?documentElement.mozRequestFullScreen():documentElement.webkitRequestFullscreen&&documentElement.webkitRequestFullscreen(Element.ALLOW_KEYBOARD_INPUT))},exitFullscreen:function(){this.isFulled&&(document.exitFullscreen?document.exitFullscreen():document.msExitFullscreen?document.msExitFullscreen():document.mozCancelFullScreen?document.mozCancelFullScreen():document.webkitExitFullscreen&&document.webkitExitFullscreen())},change:function(event){var offsetX=this.endX-this.startX,offsetY=this.endY-this.startY;switch(this.action){case"move":this.move(offsetX,offsetY);break;case"zoom":this.zoom(function(x1,y1,x2,y2){var z1=sqrt(x1*x1+y1*y1),z2=sqrt(x2*x2+y2*y2);return(z2-z1)/z1}(abs(this.startX-this.startX2),abs(this.startY-this.startY2),abs(this.endX-this.endX2),abs(this.endY-this.endY2)),!1,event),this.startX2=this.endX2,this.startY2=this.endY2;break;case"switch":this.action="switched",abs(offsetX)>abs(offsetY)&&(offsetX>1?this.prev():offsetX<-1&&this.next())}this.startX=this.endX,this.startY=this.endY},isSwitchable:function(){var image=this.image,viewer=this.viewer;return image.left>=0&&image.top>=0&&image.width<=viewer.width&&image.height<=viewer.height}},Viewer.DEFAULTS={inline:!1,button:!0,navbar:!0,title:!0,toolbar:!0,tooltip:!0,movable:!0,zoomable:!0,rotatable:!0,scalable:!0,transition:!0,fullscreen:!0,keyboard:!0,interval:5e3,minWidth:200,minHeight:100,zoomRatio:.1,minZoomRatio:.01,maxZoomRatio:100,zIndex:2015,zIndexInline:0,url:"src",build:null,built:null,show:null,shown:null,hide:null,hidden:null,view:null,viewed:null},Viewer.setDefaults=function(options){$.extend(Viewer.DEFAULTS,options)},Viewer.TEMPLATE='<div class="viewer-container"><div class="viewer-canvas"></div><div class="viewer-footer"><div class="viewer-title"></div><ul class="viewer-toolbar" style="width:184px"><li class="viewer-zoom-in" data-action="zoom-in" title="放大"></li><li class="viewer-zoom-out" data-action="zoom-out" title="缩小"></li><li class="viewer-one-to-one" data-action="one-to-one" style="display:none"></li><li class="viewer-prev" data-action="prev" title="上一张"></li><li class="viewer-play" data-action="play" title="全屏"></li><li class="viewer-next" data-action="next" title="下一张"></li><li class="viewer-rotate-left" data-action="rotate-left" style="display:none"></li><li class="viewer-rotate-right" data-action="rotate-right" title="旋转"></li><li class="viewer-reset" data-action="reset" title="重置"></li><li class="viewer-flip-horizontal" data-action="flip-horizontal" style="display:none"></li><li class="viewer-flip-vertical" data-action="flip-vertical" style="display:none"></li></ul><div class="viewer-navbar"><ul class="viewer-list"></ul></div></div><div class="viewer-tooltip"></div><div class="viewer-button" data-action="mix"></div><div class="viewer-player"></div></div>',Viewer.other=$.fn.viewer,$.fn.viewer=function(options){var result,args=toArray(arguments,1);return this.each(function(){var fn,$this=$(this),data=$this.data(NAMESPACE);if(!data){if(/destroy|hide|exit|stop|reset/.test(options))return;$this.data(NAMESPACE,data=new Viewer(this,options))}isString(options)&&$.isFunction(fn=data[options])&&(result=fn.apply(data,args))}),isUndefined(result)?this:result},$.fn.viewer.Constructor=Viewer,$.fn.viewer.setDefaults=Viewer.setDefaults,$.fn.viewer.noConflict=function(){return $.fn.viewer=Viewer.other,this}});